<html><head>
	<title>HOME</title>
	</head>
<body>
	<script src="/static/js/jquery.min.js"></script>
	<link href="/static/css/bootstrap-theme.css" rel="stylesheet">
	<link href="/static/css/bootstrap.css" rel="stylesheet">
	<script src="/static/js/bootstrap.js"></script>
	<div class="container">
			<div class="row clearfix">
				<div class="col-md-12 column">
						<nav class="navbar navbar-default" role="navigation">
								<div class="navbar-header">
									 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button> <a class="navbar-brand" href="{{ url_for('index') }}">CQUPT Hub签到平台</a>
								</div>
								
								<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
									<ul class="nav navbar-nav">
										<li class="active">
											 <a href="#">首页</a>
										</li>
									</ul>
									<ul class="nav navbar-nav navbar-right">
										<li class="dropdown">
											 <a href="#" class="dropdown-toggle" data-toggle="dropdown">功能栏<strong class="caret"></strong></a>
											<ul class="dropdown-menu">
												<li>
														<a href="{{ url_for('index') }}">首页</a>
												</li>
												<li>
														<a href="{{ url_for('admin') }}">管理员首页</a>
												</li>
												<li>
													<a href="{{ url_for('admin_stream') }}">日人流量监控平台</a>
												</li>
												<li>
													<a href="{{ url_for('admin_cluster') }}">日人流量汇总</a>
												</li>
												<li class="divider">
												</li>
												<li>
													<a href="{{ url_for('status') }}">近7日签到趋势图</a>
												</li>
												<li>
													<a href="{{ url_for('logout') }}">登出</a>
												</li>
											</ul>
										</li>
									</ul>
								</div>
								
							</nav>
							{% if current_user.is_authenticated %}
					<div class="row clearfix">
						<div class="col-md-6 column">
							<div class="row clearfix">
								<div class="col-md-4 column">
								</div>
								<div class="col-md-4 column">
									<img alt="140x140" height="140" width="140" src="data:image/jpg;base64,{{current_user.Img2Base64}}" class="img-thumbnail" />
								</div>
								<div class="col-md-4 column">
								</div>
							</div>
						</div>
						<div class="col-md-6 column">
							<div class="row clearfix">
								<div class="col-md-4 column">
								</div>
								<div class="col-md-4 column">
									<h3>
											Hello,<br/>
										{{ current_user.username }}!		
						</h3>
								</div>
								<div class="col-md-4 column">
								</div>
							</div>
							<div class="row clearfix">
								<div class="col-md-6 column">
									<div class="row clearfix">
										<div class="col-md-4 column">
										</div>
										<div class="col-md-4 column">
										</div>
										<div class="col-md-4 column">
										</div>
									</div>
								</div>
								<div class="col-md-6 column">
									<div class="row clearfix">
										<div class="col-md-4 column">
										</div>
										<div class="col-md-4 column">
										</div>
										<div class="col-md-4 column">
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<h3>签到记录:<button type="button" onclick="getMedia()" class="btn btn-default btn-danger">点我打开摄像头</button> --> <button type="button" onclick="register()" class="btn btn-default btn-primary">签到</button> --> <a id="modal-618045" href="#modal-container-618045" role="button" class="btn" data-toggle="modal">查看签到记录表</a>
			
						<div class="modal fade" id="modal-container-618045" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
										<h4 class="modal-title" id="myModalLabel2">
											请选择时间段
										</h4>
									</div>
									<div class="modal-body">
										<form method="GET" action="{{ url_for('enroll_form') }}">
										<div class="form-group">
											开始日期:<input type="date" name="start" id="download_date" class="form-control" />
											结束日期:<input type="date" name="end" id="download_rdate" class="form-control" />
										</div>
									</div>
									<div class="modal-footer">
										 <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> <button type="submit" class="btn btn-primary">提交</button>
									</div>
										</form> 
								</div>
								
							</div>
							
						</div> </h3>
					<table class="table">
							<thead>
								<tr>
									<th>
										时间
									</th>
									<th>
										记录
									</th>
								</tr>
							</thead>
							<tbody>
								{% for i in myData.sign %}
								<tr class="info">
									<td>
										{{ i.time }}
									</td>
									<td>
										<img alt="40x40" height="40" width="40" src="data:image/jpg;base64,{{i.face}}" />
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
						<h3>假条:<a id="modal-618047" href="#modal-container-618047" role="button" class="btn" data-toggle="modal"><button type="button" class="btn btn-default btn-warning">点我摸鱼</button></a>
			
							<div class="modal fade" id="modal-container-618047" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
											<h4 class="modal-title" id="myModalLabel">
												请假条
											</h4>
										</div>
										<div class="modal-body">
											<div class="form-group">
												请假理由:<input type="text" id="absent_info" class="form-control" />
												请假日期:<input type="date" id="absent_date" class="form-control" />
												返回日期:<input type="date" id="reach_date" class="form-control" />
											</div> 
										</div>
										<div class="modal-footer">
											 <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> <button type="button" onclick="absent()" class="btn btn-primary">提交</button>
										</div>
									</div>
									
								</div>
								
							</div></h3>
						<table class="table">
							<thead>
								<tr>
									<th>
										假条ID
									</th>
									<th>
										理由
									</th>
									<th>
										请假时间
									</th>
									<th>
										返回时间
									</th>
									<th>
										申请时间
									</th>
									<th>
										状态
									</th>
								</tr>
							</thead>
							<tbody>
								{% for i in myData.absent %}
								<tr class="info">
									<td>
										{{ i.id }}
									</td>
									<td>
										{{ i.info }}
									</td>
									<td>
										{{ i.abtime }}
									</td>
									<td>
										{{ i.retime }}
									</td>
									<td>
										{{ i.apptime }}
									</td>
									<td>
										{{ i.status }}
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
				</div>
			</div>
		</div>
{% endif %}
<video hidden id="video" width="500px" height="500px" autoplay="autoplay"></video>
<canvas hidden id="canvas" width="500px" height="500px"></canvas>
<script>
		function getMedia() {
			let constraints = {
				video: {width: 500, height: 500},
				audio: false
			};
			//获得video摄像头区域
			let video = document.getElementById("video");
			//这里介绍新的方法，返回一个 Promise对象
			// 这个Promise对象返回成功后的回调函数带一个 MediaStream 对象作为其参数
			// then()是Promise对象里的方法
			// then()方法是异步执行，当then()前的方法执行完后再执行then()内部的程序
			// 避免数据没有获取到
			let promise = navigator.mediaDevices.getUserMedia(constraints);
			promise.then(function (MediaStream) {
				video.srcObject = MediaStream;
				video.play();
			});
		}
	
		function takePhoto() {
		//获得Canvas对象
		let video = document.getElementById("video");
		let canvas = document.getElementById("canvas");
		let ctx = canvas.getContext('2d');
		ctx.drawImage(video, 0, 0, 500, 500);
		}
	
		function register(){
		let video = document.getElementById("video");
		let canvas = document.getElementById("canvas");
		let ctx = canvas.getContext('2d');
		ctx.drawImage(video, 0, 0, 500, 500);
		//var username = document.getElementById("username").value;
		//var password = document.getElementById("password").value;
		var dataURL = canvas.toDataURL("image/jpeg");
		dataURL = dataURL.replace("data:image/jpeg;base64,", "");
		$.ajax( {
			url:"{{ url_for('api') }}",
			type: "POST",
			data: {"faceid":dataURL,"api":"flag"},
			dataType: "json",
			//processData:false,
			//contentType: false,
	
			success: function(data){
				if (data.status == "1"){
					alert("签到成功!");
					window.location.href="{{ url_for('index') }}";
				}else if(data.status == "-1"){
					alert("请打开摄像头并将脸放于视频中间！");
				}else if(data.status == "-2"){
					alert("你今天已经签过到了!");
					window.location.href="{{ url_for('index') }}";
				}
			},
			error: function(){
				alert("网络错误，请重试!");
			}
		});
		}

		function absent(){
		let info = document.getElementById("absent_info").value;
		let date = document.getElementById("absent_date").value;
		let rdate = document.getElementById("reach_date").value;
		$.ajax( {
			url:"{{ url_for('api') }}",
			type: "POST",
			data: {"api":"absent","info":info,"date":date,"rdate":rdate},
			dataType: "json",
			//processData:false,
			//contentType: false,
	
			success: function(data){
				if (data.status == "1"){
					alert("申请成功!");
					window.location.href="{{ url_for('index') }}";
				}else if(data.status == "-1"){
					alert("请输入理由和日期!");
				}else if(data.status == "-2"){
					alert("请假日期小于今天!");
				}else if(data.status == "-3"){
					alert("返回日期小于请假日期!");
				}
			},
			error: function(){
				alert("网络错误，请重试!");
			}
		});
		}


		function download(){
		let date = document.getElementById("download_date").value;
		let rdate = document.getElementById("download_rdate").value;
		$.ajax( {
			url:"{{ url_for('api') }}",
			type: "POST",
			data: {"api":"download_enroll_info","start":date,"end":rdate},
			dataType: "json",
			//processData:false,
			//contentType: false,
	
			success: function(data){
				if (data.status == "1"){
					alert("申请成功!");
				}else if(data.status == "-1"){
					alert("请输入日期!");
				}
			},
			error: function(){
				alert("网络错误，请重试!");
			}
		});
		}
	
	</script>
</body>
